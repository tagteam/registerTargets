#+TITLE: PhD course: Targeted Register Analysis: Exercises: Day 4 part 2

* Objectives

The learning targets of this exercise are:

- Comparison of the IPW estimator (inverse probability of censoring
  and treatment weighted estimator), the G-computation estimator
  (G-formula) and the TMLE estimator.

** Reading references

- https://pubmed.ncbi.nlm.nih.gov/21030422/ (read in this paper as much as time permits)

----------------------------------------------------------------------

* Estimator comparison

- The following targets estimate the standardized 2-year risks of MACE
  with the g-computation estimator (without TMLE step) and the inverse
  probability of treatment and censoring weighted estimator,
  respectively. Add them to the pipeline and call tar_make.

#+BEGIN_SRC R  :results output raw  :exports code  :session *R* :cache yes
tar_target(ltmle_gcomp_mace_2,
           run_Ltmle(name_outcome="mace",
                     name_competing_risk = "Dead",
                     name_censoring = "Censored",
                     censored_label = 0,
                     time_horizon=4,
                     outcome_data=mace_outcome_data,
                     regimen_data=list(Drug = regimen_data),
                     baseline_data=baseline_covariates,
                     timevar_data=time_covariates,
                     abar = list(control = rep(0,4),treat = rep(1,4)),
                     gcomp = TRUE,
                     SL.library="glm",
                     verbose=TRUE)),
tar_target(ltmle_ipw_mace_2,
           run_Ltmle(name_outcome="mace",
                     name_competing_risk = "Dead",
                     name_censoring = "Censored",
                     censored_label = 0,
                     time_horizon=4,
                     outcome_data=mace_outcome_data,
                     regimen_data=list(Drug = regimen_data),
                     baseline_data=baseline_covariates,
                     timevar_data=time_covariates,
                     abar = list(control = rep(0,4),treat = rep(1,4)),
                     iptw.only = TRUE,
                     SL.library="glm",
                     verbose=TRUE)
           )
#+END_SRC  

- Add also the corresponding summary tables as targets to the pipeline and
  compare with the LTMLE fit =ltmle_summary_mace_2=:

#+BEGIN_SRC R  :results output raw  :exports code  :session *R* :cache yes  
tar_load_everything()
ltmle_summary_mace_2
ltmle_summary_ipw_mace_2
ltmle_summary_gcomp_mace_2
#+END_SRC  

- Repeat all three analyses in the relatively small subset of subjects
  who have a high education:

#+BEGIN_SRC R  :results output raw  :exports code  :session *R* :cache yes  
tar_target(ltmle_gcomp_mace_2_subset,
           run_Ltmle(name_outcome="mace",
                     name_competing_risk = "Dead",
                     name_censoring = "Censored",
                     censored_label = 0,
                     time_horizon=4,
                     sub_set = list(data = baseline_covariates[education == "High",.(pnr)]),
                     outcome_data=mace_outcome_data,
                     regimen_data=list(Drug = regimen_data),
                     baseline_data=baseline_covariates,
                     timevar_data=time_covariates,
                     abar = list(control = rep(0,4),treat = rep(1,4)),
                     gcomp = TRUE,
                     SL.library="glm",
                     verbose=TRUE)),
tar_target(ltmle_summary_gcomp_mace_2_subset,{
  summary(ltmle_gcomp_mace_2_subset)
}),
tar_target(ltmle_ipw_mace_2_subset,
           run_Ltmle(name_outcome="mace",
                     name_competing_risk = "Dead",
                     name_censoring = "Censored",
                     censored_label = 0,
                     time_horizon=4,
                     sub_set = list(data = baseline_covariates[education == "High",.(pnr)]),
                     outcome_data=mace_outcome_data,
                     regimen_data=list(Drug = regimen_data),
                     baseline_data=baseline_covariates,
                     timevar_data=time_covariates,
                     abar = list(control = rep(0,4),treat = rep(1,4)),
                     iptw.only = TRUE,
                     SL.library="glm",
                     verbose=TRUE)),
tar_target(ltmle_summary_ipw_mace_2_subset,{
  summary(ltmle_ipw_mace_2_subset)
}),
tar_target(ltmle_fit_glm_mace_2_subset,
           run_Ltmle(name_outcome="mace",
                     name_competing_risk = "Dead",
                     name_censoring = "Censored",
                     censored_label = 0,
                     time_horizon=4,
                     sub_set = list(data = baseline_covariates[education == "High",.(pnr)]),
                     outcome_data=mace_outcome_data,
                     regimen_data=list(Drug = regimen_data),
                     baseline_data=baseline_covariates,
                     timevar_data=time_covariates,
                     abar = list(control = rep(0,4),treat = rep(1,4)),
                     SL.library="glm",
                     verbose=TRUE)),
tar_target(ltmle_summary_glm_mace_2_subset,{
  summary(ltmle_fit_glm_mace_2_subset)
})
#+END_SRC

- Compare the three estimators in the subset of subjects who have a high education

#+BEGIN_SRC R  :results output raw  :exports code  :session *R* :cache yes  
tar_load_everything()
ltmle_summary_gcomp_mace_2_subset
ltmle_summary_ipw_mace_2_subset
ltmle_summary_glm_mace_2_subset
#+END_SRC  
